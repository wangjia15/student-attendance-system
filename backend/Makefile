# Student Attendance System - Backend Makefile
# Provides convenient commands for development workflow

.PHONY: help install dev test lint format clean run migrations docker

# Default target
help:
	@echo "ğŸ“ Student Attendance System - Backend Commands"
	@echo "=============================================="
	@echo ""
	@echo "ğŸ“¦ Setup & Installation:"
	@echo "  make install     Install dependencies with uv"
	@echo "  make install-dev Install with development dependencies"
	@echo "  make clean       Clean cache and build artifacts"
	@echo ""
	@echo "ğŸš€ Development:"
	@echo "  make run         Start development server"
	@echo "  make run-prod    Start production server with Gunicorn"
	@echo "  make shell       Start interactive Python shell"
	@echo ""
	@echo "ğŸ—„ï¸  Database:"
	@echo "  make migrate     Run database migrations"
	@echo "  make migration   Create new migration"
	@echo "  make db-reset    Reset database (WARNING: destroys data)"
	@echo ""
	@echo "ğŸ§ª Testing:"
	@echo "  make test        Run all tests"
	@echo "  make test-unit   Run unit tests only"
	@echo "  make test-cov    Run tests with coverage report"
	@echo "  make test-perf   Run performance tests"
	@echo "  make test-sec    Run security tests"
	@echo "  make test-all    Run comprehensive test suite"
	@echo ""
	@echo "ğŸ”§ Code Quality:"
	@echo "  make lint        Run all linting tools"
	@echo "  make format      Format code with black and isort"
	@echo "  make type-check  Run type checking with mypy"
	@echo "  make pre-commit  Run pre-commit hooks"
	@echo ""
	@echo "ğŸ³ Docker:"
	@echo "  make docker-build    Build Docker image"
	@echo "  make docker-run      Run Docker container"
	@echo "  make docker-compose  Start with docker-compose"
	@echo ""

# Installation
install:
	@echo "ğŸ“¦ Installing dependencies..."
	uv sync

install-dev:
	@echo "ğŸ“¦ Installing development dependencies..."
	uv sync --group dev

# Development server
run:
	@echo "ğŸš€ Starting development server..."
	uv run uvicorn main:app --reload --host 0.0.0.0 --port 8000

run-prod:
	@echo "ğŸš€ Starting production server..."
	uv run gunicorn main:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000

shell:
	@echo "ğŸ Starting interactive Python shell..."
	uv run python -c "import IPython; IPython.start_ipython()"

# Database management
migrate:
	@echo "â¬†ï¸ Running database migrations..."
	uv run alembic upgrade head

migration:
	@echo "ğŸ“ Creating new migration..."
	@read -p "Migration message: " msg; \
	uv run alembic revision --autogenerate -m "$$msg"

db-reset:
	@echo "âš ï¸  This will destroy all data! Are you sure? [y/N]"
	@read confirm; \
	if [ "$$confirm" = "y" ] || [ "$$confirm" = "Y" ]; then \
		rm -f attendance.db; \
		uv run alembic upgrade head; \
		echo "âœ… Database reset complete"; \
	else \
		echo "âŒ Database reset cancelled"; \
	fi

# Testing
test:
	@echo "ğŸ§ª Running tests..."
	uv run pytest -v

test-unit:
	@echo "ğŸ§ª Running unit tests..."
	uv run pytest tests/unit/ -v

test-cov:
	@echo "ğŸ§ª Running tests with coverage..."
	uv run pytest --cov=app --cov-report=html --cov-report=term

test-perf:
	@echo "âš¡ Running performance tests..."
	uv run pytest tests/performance/ -v -m performance

test-sec:
	@echo "ğŸ”’ Running security tests..."
	uv run pytest tests/security/ -v -m security

test-all:
	@echo "ğŸ§ª Running comprehensive test suite..."
	uv run python run_comprehensive_tests.py

# Code quality
lint:
	@echo "ğŸ” Running linting tools..."
	uv run flake8 app/
	uv run mypy app/
	@echo "âœ… Linting complete"

format:
	@echo "ğŸ¨ Formatting code..."
	uv run black app/
	uv run isort app/
	@echo "âœ… Code formatting complete"

type-check:
	@echo "ğŸ” Running type checker..."
	uv run mypy app/

pre-commit:
	@echo "ğŸ”§ Running pre-commit hooks..."
	uv run pre-commit run --all-files

# Docker
docker-build:
	@echo "ğŸ³ Building Docker image..."
	docker build -t student-attendance-backend .

docker-run:
	@echo "ğŸ³ Running Docker container..."
	docker run -p 8000:8000 --env-file .env student-attendance-backend

docker-compose:
	@echo "ğŸ³ Starting with docker-compose..."
	docker-compose up -d

# Cleanup
clean:
	@echo "ğŸ§¹ Cleaning up..."
	find . -type d -name "__pycache__" -delete
	find . -type f -name "*.pyc" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	find . -type d -name ".pytest_cache" -exec rm -rf {} +
	find . -type d -name ".coverage" -delete
	find . -type d -name "htmlcov" -exec rm -rf {} +
	@echo "âœ… Cleanup complete"

# Development workflow shortcuts
dev: install-dev migrate
	@echo "ğŸ‰ Development environment ready!"
	@echo "Run 'make run' to start the server"

ci: lint test
	@echo "âœ… CI checks passed"

# Quick setup for new developers
setup: install-dev migrate
	@echo "ğŸ‰ Setup complete!"
	@echo ""
	@echo "ğŸš€ Next steps:"
	@echo "  1. Review .env file settings"
	@echo "  2. Run 'make run' to start development server"
	@echo "  3. Open http://localhost:8000/docs for API documentation"